"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const convert_1 = require("../convert");
const languageclient_1 = require("../languageclient");
// Public: Listen to diagnostics messages from the language server and publish them
// to the user by way of the Linter Push (Indie) v2 API supported by Atom IDE UI.
class LinterPushV2Adapter {
    // Public: Create a new {LinterPushV2Adapter} that will listen for diagnostics
    // via the supplied {LanguageClientConnection}.
    //
    // * `connection` A {LanguageClientConnection} to the language server that will provide diagnostics.
    constructor(connection) {
        this._diagnosticMap = new Map();
        this._diagnosticCodes = new Map();
        this._indies = new Set();
        connection.onPublishDiagnostics(this.captureDiagnostics.bind(this));
    }
    // Dispose this adapter ensuring any resources are freed and events unhooked.
    dispose() {
        this.detachAll();
    }
    // Public: Attach this {LinterPushV2Adapter} to a given {V2IndieDelegate} registry.
    //
    // * `indie` A {V2IndieDelegate} that wants to receive messages.
    attach(indie) {
        this._indies.add(indie);
        this._diagnosticMap.forEach((value, key) => indie.setMessages(key, value));
        indie.onDidDestroy(() => {
            this._indies.delete(indie);
        });
    }
    // Public: Remove all {V2IndieDelegate} registries attached to this adapter and clear them.
    detachAll() {
        this._indies.forEach((i) => i.clearMessages());
        this._indies.clear();
    }
    // Public: Capture the diagnostics sent from a langguage server, convert them to the
    // Linter V2 format and forward them on to any attached {V2IndieDelegate}s.
    //
    // * `params` The {PublishDiagnosticsParams} received from the language server that should
    //            be captured and forwarded on to any attached {V2IndieDelegate}s.
    captureDiagnostics(params) {
        const path = convert_1.default.uriToPath(params.uri);
        const codeMap = new Map();
        const messages = params.diagnostics.map((d) => {
            const linterMessage = this.diagnosticToV2Message(path, d);
            codeMap.set(getCodeKey(linterMessage.location.position, d.message), d.code);
            return linterMessage;
        });
        this._diagnosticMap.set(path, messages);
        this._diagnosticCodes.set(path, codeMap);
        this._indies.forEach((i) => i.setMessages(path, messages));
    }
    // Public: Convert a single {Diagnostic} received from a language server into a single
    // {V2Message} expected by the Linter V2 API.
    //
    // * `path` A string representing the path of the file the diagnostic belongs to.
    // * `diagnostics` A {Diagnostic} object received from the language server.
    //
    // Returns a {V2Message} equivalent to the {Diagnostic} object supplied by the language server.
    diagnosticToV2Message(path, diagnostic) {
        const message = {
            location: {
                file: path,
                position: convert_1.default.lsRangeToAtomRange(diagnostic.range),
            },
            excerpt: diagnostic.message,
            linterName: diagnostic.source,
            severity: LinterPushV2Adapter.diagnosticSeverityToSeverity(diagnostic.severity || -1),
        };
        if (diagnostic.relatedInformation) {
            message.description = diagnostic.relatedInformation.map(this.diagnosticRelatedInformation, this).join('\n');
        }
        return message;
    }
    /**
     * Creates a markdown formatted string representing the related information.
     * @param  relatedInformation The related information
     * @return                    The markdown formatted string
     */
    diagnosticRelatedInformation(relatedInformation) {
        const link = this.markdownFileLink(convert_1.default.uriToPath(relatedInformation.location.uri), convert_1.default.positionToPoint(relatedInformation.location.range.start));
        return `* [${relatedInformation.message}](${link})`;
    }
    /**
     * Creates a markdown formatted link that opens the given file.
     * It also moves the cursor to the given point.
     * @param  filename The path to the file
     * @param  point    A point to move the cursor to
     * @return          The markdown link
     */
    markdownFileLink(filename, point) {
        const params = ['filename=' + encodeURIComponent(filename)];
        if (point.row > 0) {
            params.push('line=' + (point.row + 1)); // +1 because the link uses 1 based numbers
            if (point.column > 0) {
                params.push('column=' + (point.column + 1)); // +1 because the link uses 1 based numbers
            }
        }
        return 'atom://core/open/file?' + params.join('&');
    }
    // Public: Convert a diagnostic severity number obtained from the language server into
    // the textual equivalent for a Linter {V2Message}.
    //
    // * `severity` A number representing the severity of the diagnostic.
    //
    // Returns a string of 'error', 'warning' or 'info' depending on the severity.
    static diagnosticSeverityToSeverity(severity) {
        switch (severity) {
            case languageclient_1.DiagnosticSeverity.Error:
                return 'error';
            case languageclient_1.DiagnosticSeverity.Warning:
                return 'warning';
            case languageclient_1.DiagnosticSeverity.Information:
            case languageclient_1.DiagnosticSeverity.Hint:
            default:
                return 'info';
        }
    }
    // Private: Get the recorded diagnostic code for a range/message.
    // Diagnostic codes are tricky because there's no suitable place in the Linter API for them.
    // For now, we'll record the original code for each range/message combination and retrieve it
    // when needed (e.g. for passing back into code actions)
    getDiagnosticCode(editor, range, text) {
        const path = editor.getPath();
        if (path != null) {
            const diagnosticCodes = this._diagnosticCodes.get(path);
            if (diagnosticCodes != null) {
                return diagnosticCodes.get(getCodeKey(range, text)) || null;
            }
        }
        return null;
    }
}
exports.default = LinterPushV2Adapter;
function getCodeKey(range, text) {
    return [].concat(...range.serialize(), text).join(',');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGludGVyLXB1c2gtdjItYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9saW50ZXItcHVzaC12Mi1hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsd0NBQWlDO0FBQ2pDLHNEQU8yQjtBQUUzQixtRkFBbUY7QUFDbkYsaUZBQWlGO0FBQ2pGLE1BQXFCLG1CQUFtQjtJQUt0Qyw4RUFBOEU7SUFDOUUsK0NBQStDO0lBQy9DLEVBQUU7SUFDRixvR0FBb0c7SUFDcEcsWUFBWSxVQUFvQztRQVJ4QyxtQkFBYyxHQUFrQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzFELHFCQUFnQixHQUFvRCxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzlFLFlBQU8sR0FBOEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQU9yRCxVQUFVLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7SUFFRCw2RUFBNkU7SUFDdEUsT0FBTztRQUNaLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBRUQsbUZBQW1GO0lBQ25GLEVBQUU7SUFDRixnRUFBZ0U7SUFDekQsTUFBTSxDQUFDLEtBQTJCO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUMzRSxLQUFLLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRTtZQUN0QixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztJQUNMLENB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UUFDOUIsSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO1lBQ2hCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDeEQsSUFBSSxlQUFlLElBQUksSUFBSSxFQUFFO2dCQUMzQixPQUFPLGVBQWUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQzthQUM3RDtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUE5SUQsc0NBOElDO0FBRUQsU0FBUyxVQUFVLENBQUMsS0FBaUIsRUFBRSxJQUFZO0lBQ2pELE9BQVEsRUFBWSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEtBQUssQ0FBQyxTQUFTLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDcEUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGxpbnRlciBmcm9tICdhdG9tL2xpbnRlcic7XG5pbXBvcnQgKiBhcyBhdG9tIGZyb20gJ2F0b20nO1xuaW1wb3J0IENvbnZlcnQgZnJvbSAnLi4vY29udmVydCc7XG5pbXBvcnQge1xuICBEaWFnbm9zdGljLFxuICBEaWFnbm9zdGljUmVsYXRlZEluZm9ybWF0aW9uLFxuICBEaWFnbm9zdGljQ29kZSxcbiAgRGlhZ25vc3RpY1NldmVyaXR5LFxuICBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXG4gIFB1Ymxpc2hEaWFnbm9zdGljc1BhcmFtcyxcbn0gZnJvbSAnLi4vbGFuZ3VhZ2VjbGllbnQnO1xuXG4vLyBQdWJsaWM6IExpc3RlbiB0byBkaWFnbm9zdGljcyBtZXNzYWdlcyBmcm9tIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgYW5kIHB1Ymxpc2ggdGhlbVxuLy8gdG8gdGhlIHVzZXIgYnkgd2F5IG9mIHRoZSBMaW50ZXIgUHVzaCAoSW5kaWUpIHYyIEFQSSBzdXBwb3J0ZWQgYnkgQXRvbSBJREUgVUkuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMaW50ZXJQdXNoVjJBZGFwdGVyIHtcbiAgcHJpdmF0ZSBfZGlhZ25vc3RpY01hcDogTWFwPHN0cmluZywgbGludGVyLk1lc3NhZ2VbXT4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgX2RpYWdub3N0aWNDb2RlczogTWFwPHN0cmluZywgTWFwPHN0cmluZywgRGlhZ25vc3RpY0NvZGUgfCBudWxsPj4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgX2luZGllczogU2V0PGxpbnRlci5JbmRpZURlbGVnYXRlPiA9IG5ldyBTZXQoKTtcblxuICAvLyBQdWJsaWM6IENyZWF0ZSBhIG5ldyB7TGludGVyUHVzaFYyQWRhcHRlcn0gdGhhdCB3aWxsIGxpc3RlbiBmb3IgZGlhZ25vc3RpY3NcbiAgLy8gdmlhIHRoZSBzdXBwbGllZCB7TGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9ufS5cbiAgLy9cbiAgLy8gKiBgY29ubmVjdGlvbmAgQSB7TGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9ufSB0byB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHRoYXQgd2lsbCBwcm92aWRlIGRpYWdub3N0aWNzLlxuICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24pIHtcbiAgICBjb25uZWN0aW9uLm9uUHVibGlzaERpYWdub3N0aWNzKHRoaXMuY2FwdHVyZURpYWdub3N0aWNzLmJpbmQodGhpcykpO1xuICB9XG5cbiAgLy8gRGlzcG9zZSB0aGlzIGFkYXB0ZXIgZW5zdXJpbmcgYW55IHJlc291cmNlcyBhcmUgZnJlZWQgYW5kIGV2ZW50cyB1bmhvb2tlZC5cbiAgcHVibGljIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgdGhpcy5kZXRhY2hBbGwoKTtcbiAgfVxuXG4gIC8vIFB1YmxpYzogQXR0YWNoIHRoaXMge0xpbnRlclB1c2hWMkFkYXB0ZXJ9IHRvIGEgZ2l2ZW4ge1YySW5kaWVEZWxlZ2F0ZX0gcmVnaXN0cnkuXG4gIC8vXG4gIC8vICogYGluZGllYCBBIHtWMkluZGllRGVsZWdhdGV9IHRoYXQgd2FudHMgdG8gcmVjZWl2ZSBtZXNzYWdlcy5cbiAgcHVibGljIGF0dGFjaChpbmRpZTogbGludGVyLkluZGllRGVsZWdhdGUpOiB2b2lkIHtcbiAgICB0aGlzLl9pbmRpZXMuYWRkKGluZGllKTtcbiAgICB0aGlzLl9kaWFnbm9zdGljTWFwLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IGluZGllLnNldE1lc3NhZ2VzKGtleSwgdmFsdWUpKTtcbiAgICBpbmRpZS5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgdGhpcy5faW5kaWVzLmRlbGV0ZShpbmRpZSk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBQdWJsaWM6IFJlbW92ZSBhbGwge1YySW5kaWVEZWxlZ2F0ZX0gcmVnaXN0cmllcyBhdHRhY2hlZCB0byB0aGlzIGFkYXB0ZXIgYW5kIGNsZWFyIHRoZW0uXG4gIHB1YmxpYyBkZXRhY2hBbGwoKTogdm9pZCB7XG4gICAgdGhpcy5faW5kaWVzLmZvckVhY2goKGkpID0+IGkuY2xlYXJNZXNzYWdlcygpKTtcbiAgICB0aGlzLl9pbmRpZXMuY2xlYXIoKTtcbiAgfVxuXG4gIC8vIFB1YmxpYzogQ2FwdHVyZSB0aGUgZGlhZ25vc3RpY3Mgc2VudCBmcm9tIGEgbGFuZ2d1YWdlIHNlcnZlciwgY29udmVydCB0aGVtIHRvIHRoZVxuICAvLyBMaW50ZXIgVjIgZm9ybWF0IGFuZCBmb3J3YXJkIHRoZW0gb24gdG8gYW55IGF0dGFjaGVkIHtWMkluZGllRGVsZWdhdGV9cy5cbiAgLy9cbiAgLy8gKiBgcGFyYW1zYCBUaGUge1B1Ymxpc2hEaWFnbm9zdGljc1BhcmFtc30gcmVjZWl2ZWQgZnJvbSB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHRoYXQgc2hvdWxkXG4gIC8vICAgICAgICAgICAgYmUgY2FwdHVyZWQgYW5kIGZvcndhcmRlZCBvbiB0byBhbnkgYXR0YWNoZWQge1YySW5kaWVEZWxlZ2F0ZX1zLlxuICBwdWJsaWMgY2FwdHVyZURpYWdub3N0aWNzKHBhcmFtczogUHVibGlzaERpYWdub3N0aWNzUGFyYW1zKTogdm9pZCB7XG4gICAgY29uc3QgcGF0aCA9IENvbnZlcnQudXJpVG9QYXRoKHBhcmFtcy51cmkpO1xuICAgIGNvbnN0IGNvZGVNYXAgPSBuZXcgTWFwKCk7XG4gICAgY29uc3QgbWVzc2FnZXMgPSBwYXJhbXMuZGlhZ25vc3RpY3MubWFwKChkKSA9PiB7XG4gICAgICBjb25zdCBsaW50ZXJNZXNzYWdlID0gdGhpcy5kaWFnbm9zdGljVG9WMk1lc3NhZ2UocGF0aCwgZCk7XG4gICAgICBjb2RlTWFwLnNldChnZXRDb2RlS2V5KGxpbnRlck1lc3NhZ2UubG9jYXRpb24ucG9zaXRpb24sIGQubWVzc2FnZSksIGQuY29kZSk7XG4gICAgICByZXR1cm4gbGludGVyTWVzc2FnZTtcbiAgICB9KTtcbiAgICB0aGlzLl9kaWFnbm9zdGljTWFwLnNldChwYXRoLCBtZXNzYWdlcyk7XG4gICAgdGhpcy5fZGlhZ25vc3RpY0NvZGVzLnNldChwYXRoLCBjb2RlTWFwKTtcbiAgICB0aGlzLl9pbmRpZXMuZm9yRWFjaCgoaSkgPT4gaS5zZXRNZXNzYWdlcyhwYXRoLCBtZXNzYWdlcykpO1xuICB9XG5cbiAgLy8gUHVibGljOiBDb252ZXJ0IGEgc2luZ2xlIHtEaWFnbm9zdGljfSByZWNlaXZlZCBmcm9tIGEgbGFuZ3VhZ2Ugc2VydmVyIGludG8gYSBzaW5nbGVcbiAgLy8ge1YyTWVzc2FnZX0gZXhwZWN0ZWQgYnkgdGhlIExpbnRlciBWMiBBUEkuXG4gIC8vXG4gIC8vICogYHBhdGhgIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgcGF0aCBvZiB0aGUgZmlsZSB0aGUgZGlhZ25vc3RpYyBiZWxvbmdzIHRvLlxuICAvLyAqIGBkaWFnbm9zdGljc2AgQSB7RGlhZ25vc3RpY30gb2JqZWN0IHJlY2VpdmVkIGZyb20gdGhlIGxhbmd1YWdlIHNlcnZlci5cbiAgLy9cbiAgLy8gUmV0dXJucyBhIHtWMk1lc3NhZ2V9IGVxdWl2YWxlbnQgdG8gdGhlIHtEaWFnbm9zdGljfSBvYmplY3Qgc3VwcGxpZWQgYnkgdGhlIGxhbmd1YWdlIHNlcnZlci5cbiAgcHVibGljIGRpYWdub3N0aWNUb1YyTWVzc2FnZShwYXRoOiBzdHJpbmcsIGRpYWdub3N0aWM6IERpYWdub3N0aWMpOiBsaW50ZXIuTWVzc2FnZSB7XG4gICAgY29uc3QgbWVzc2FnZTogbGludGVyLk1lc3NhZ2UgPSB7XG4gICAgICBsb2NhdGlvbjoge1xuICAgICAgICBmaWxlOiBwYXRoLFxuICAgICAgICBwb3NpdGlvbjogQ29udmVydC5sc1JhbmdlVG9BdG9tUmFuZ2UoZGlhZ25vc3RpYy5yYW5nZSksXG4gICAgICB9LFxuICAgICAgZXhjZXJwdDogZGlhZ25vc3RpYy5tZXNzYWdlLFxuICAgICAgbGludGVyTmFtZTogZGlhZ25vc3RpYy5zb3VyY2UsXG4gICAgICBzZXZlcml0eTogTGludGVyUHVzaFYyQWRhcHRlci5kaWFnbm9zdGljU2V2ZXJpdHlUb1NldmVyaXR5KGRpYWdub3N0aWMuc2V2ZXJpdHkgfHwgLTEpLFxuICAgIH07XG5cbiAgICBpZiAoZGlhZ25vc3RpYy5yZWxhdGVkSW5mb3JtYXRpb24pIHtcbiAgICAgIG1lc3NhZ2UuZGVzY3JpcHRpb24gPSBkaWFnbm9zdGljLnJlbGF0ZWRJbmZvcm1hdGlvbi5tYXAodGhpcy5kaWFnbm9zdGljUmVsYXRlZEluZm9ybWF0aW9uLCB0aGlzKS5qb2luKCdcXG4nKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWVzc2FnZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgbWFya2Rvd24gZm9ybWF0dGVkIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIHJlbGF0ZWQgaW5mb3JtYXRpb24uXG4gICAqIEBwYXJhbSAgcmVsYXRlZEluZm9ybWF0aW9uIFRoZSByZWxhdGVkIGluZm9ybWF0aW9uXG4gICAqIEByZXR1cm4gICAgICAgICAgICAgICAgICAgIFRoZSBtYXJrZG93biBmb3JtYXR0ZWQgc3RyaW5nXG4gICAqL1xuICBwdWJsaWMgZGlhZ25vc3RpY1JlbGF0ZWRJbmZvcm1hdGlvbihyZWxhdGVkSW5mb3JtYXRpb246IERpYWdub3N0aWNSZWxhdGVkSW5mb3JtYXRpb24pOiBzdHJpbmcge1xuICAgIGNvbnN0IGxpbmsgPSB0aGlzLm1hcmtkb3duRmlsZUxpbmsoXG4gICAgICBDb252ZXJ0LnVyaVRvUGF0aChyZWxhdGVkSW5mb3JtYXRpb24ubG9jYXRpb24udXJpKSxcbiAgICAgIENvbnZlcnQucG9zaXRpb25Ub1BvaW50KHJlbGF0ZWRJbmZvcm1hdGlvbi5sb2NhdGlvbi5yYW5nZS5zdGFydCksXG4gICAgKTtcbiAgICByZXR1cm4gYCogWyR7cmVsYXRlZEluZm9ybWF0aW9uLm1lc3NhZ2V9XSgke2xpbmt9KWA7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhIG1hcmtkb3duIGZvcm1hdHRlZCBsaW5rIHRoYXQgb3BlbnMgdGhlIGdpdmVuIGZpbGUuXG4gICAqIEl0IGFsc28gbW92ZXMgdGhlIGN1cnNvciB0byB0aGUgZ2l2ZW4gcG9pbnQuXG4gICAqIEBwYXJhbSAgZmlsZW5hbWUgVGhlIHBhdGggdG8gdGhlIGZpbGVcbiAgICogQHBhcmFtICBwb2ludCAgICBBIHBvaW50IHRvIG1vdmUgdGhlIGN1cnNvciB0b1xuICAgKiBAcmV0dXJuICAgICAgICAgIFRoZSBtYXJrZG93biBsaW5rXG4gICAqL1xuICBwdWJsaWMgbWFya2Rvd25GaWxlTGluayhmaWxlbmFtZTogc3RyaW5nLCBwb2ludDogYXRvbS5Qb2ludCk6IHN0cmluZyB7XG4gICAgY29uc3QgcGFyYW1zID0gWydmaWxlbmFtZT0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGZpbGVuYW1lKV07XG4gICAgaWYgKHBvaW50LnJvdyA+IDApIHtcbiAgICAgIHBhcmFtcy5wdXNoKCdsaW5lPScgKyAocG9pbnQucm93ICsgMSkpOyAvLyArMSBiZWNhdXNlIHRoZSBsaW5rIHVzZXMgMSBiYXNlZCBudW1iZXJzXG4gICAgICBpZiAocG9pbnQuY29sdW1uID4gMCkge1xuICAgICAgICBwYXJhbXMucHVzaCgnY29sdW1uPScgKyAocG9pbnQuY29sdW1uICsgMSkpOyAvLyArMSBiZWNhdXNlIHRoZSBsaW5rIHVzZXMgMSBiYXNlZCBudW1iZXJzXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiAnYXRvbTovL2NvcmUvb3Blbi9maWxlPycgKyBwYXJhbXMuam9pbignJicpO1xuICB9XG5cbiAgLy8gUHVibGljOiBDb252ZXJ0IGEgZGlhZ25vc3RpYyBzZXZlcml0eSBudW1iZXIgb2J0YWluZWQgZnJvbSB0aGUgbGFuZ3VhZ2Ugc2VydmVyIGludG9cbiAgLy8gdGhlIHRleHR1YWwgZXF1aXZhbGVudCBmb3IgYSBMaW50ZXIge1YyTWVzc2FnZX0uXG4gIC8vXG4gIC8vICogYHNldmVyaXR5YCBBIG51bWJlciByZXByZXNlbnRpbmcgdGhlIHNldmVyaXR5IG9mIHRoZSBkaWFnbm9zdGljLlxuICAvL1xuICAvLyBSZXR1cm5zIGEgc3RyaW5nIG9mICdlcnJvcicsICd3YXJuaW5nJyBvciAnaW5mbycgZGVwZW5kaW5nIG9uIHRoZSBzZXZlcml0eS5cbiAgcHVibGljIHN0YXRpYyBkaWFnbm9zdGljU2V2ZXJpdHlUb1NldmVyaXR5KHNldmVyaXR5OiBudW1iZXIpOiAnZXJyb3InIHwgJ3dhcm5pbmcnIHwgJ2luZm8nIHtcbiAgICBzd2l0Y2ggKHNldmVyaXR5KSB7XG4gICAgICBjYXNlIERpYWdub3N0aWNTZXZlcml0eS5FcnJvcjpcbiAgICAgICAgcmV0dXJuICdlcnJvcic7XG4gICAgICBjYXNlIERpYWdub3N0aWNTZXZlcml0eS5XYXJuaW5nOlxuICAgICAgICByZXR1cm4gJ3dhcm5pbmcnO1xuICAgICAgY2FzZSBEaWFnbm9zdGljU2V2ZXJpdHkuSW5mb3JtYXRpb246XG4gICAgICBjYXNlIERpYWdub3N0aWNTZXZlcml0eS5IaW50OlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuICdpbmZvJztcbiAgICB9XG4gIH1cblxuICAvLyBQcml2YXRlOiBHZXQgdGhlIHJlY29yZGVkIGRpYWdub3N0aWMgY29kZSBmb3IgYSByYW5nZS9tZXNzYWdlLlxuICAvLyBEaWFnbm9zdGljIGNvZGVzIGFyZSB0cmlja3kgYmVjYXVzZSB0aGVyZSdzIG5vIHN1aXRhYmxlIHBsYWNlIGluIHRoZSBMaW50ZXIgQVBJIGZvciB0aGVtLlxuICAvLyBGb3Igbm93LCB3ZSdsbCByZWNvcmQgdGhlIG9yaWdpbmFsIGNvZGUgZm9yIGVhY2ggcmFuZ2UvbWVzc2FnZSBjb21iaW5hdGlvbiBhbmQgcmV0cmlldmUgaXRcbiAgLy8gd2hlbiBuZWVkZWQgKGUuZy4gZm9yIHBhc3NpbmcgYmFjayBpbnRvIGNvZGUgYWN0aW9ucylcbiAgcHVibGljIGdldERpYWdub3N0aWNDb2RlKGVkaXRvcjogYXRvbS5UZXh0RWRpdG9yLCByYW5nZTogYXRvbS5SYW5nZSwgdGV4dDogc3RyaW5nKTogRGlhZ25vc3RpY0NvZGUgfCBudWxsIHtcbiAgICBjb25zdCBwYXRoID0gZWRpdG9yLmdldFBhdGgoKTtcbiAgICBpZiAocGF0aCAhPSBudWxsKSB7XG4gICAgICBjb25zdCBkaWFnbm9zdGljQ29kZXMgPSB0aGlzLl9kaWFnbm9zdGljQ29kZXMuZ2V0KHBhdGgpO1xuICAgICAgaWYgKGRpYWdub3N0aWNDb2RlcyAhPSBudWxsKSB7XG4gICAgICAgIHJldHVybiBkaWFnbm9zdGljQ29kZXMuZ2V0KGdldENvZGVLZXkocmFuZ2UsIHRleHQpKSB8fCBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRDb2RlS2V5KHJhbmdlOiBhdG9tLlJhbmdlLCB0ZXh0OiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gKFtdIGFzIGFueVtdKS5jb25jYXQoLi4ucmFuZ2Uuc2VyaWFsaXplKCksIHRleHQpLmpvaW4oJywnKTtcbn1cbiJdfQ==