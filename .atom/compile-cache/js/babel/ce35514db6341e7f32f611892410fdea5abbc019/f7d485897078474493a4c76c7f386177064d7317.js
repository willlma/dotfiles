var _atom = require('atom');

'use babel';

var escapeRegExp = require('escape-regex-string');
var repeating = require('repeating');

function max(arr) {
  return arr.reduce(function (cur, next) {
    return next > cur ? next : cur;
  }, 0);
}

var CHARACTER_RE = new RegExp('[\\w' + 'А-ЯЁа-яё' + ']');

// AtomHardWrap
module.exports = {
  subscriptions: null,

  activate: function activate(state) {
    var _this = this;

    this.subscriptions = new _atom.CompositeDisposable();

    // Register command that toggles this view
    this.subscriptions.add(atom.commands.add('atom-text-editor', {
      'hard-wrap:reflow-selection': function hardWrapReflowSelection() {
        return _this.reflowSelection();
      }
    }));
  },

  deactivate: function deactivate() {
    this.subscriptions.dispose();
  },

  getMaxLineLength: function getMaxLineLength(range, textEditor) {
    var maxLen = 0;
    for (var row of range.getBufferRange().getRows()) {
      var len = textEditor.lineTextForBufferRow(row).length;
      if (len > maxLen) {
        maxLen = len;
      }
    }
    return maxLen;
  },

  getWrapColumn: function getWrapColumn(range, textEditor) {
    if (!atom.packages.isPackageLoaded('multi-wrap-guide')) {
      return atom.config.get('editor.preferredLineLength', { scope: textEditor.getRootScopeDescriptor() });
    }

    try {
      var textEditorView = atom.views.getView(textEditor);
      var wrapGuideView = textEditorView.rootElement.querySelector('.multi-wrap-guide-view');
      var columns = wrapGuideView.spacePenView.columns;
      if (columns.length === 0) {
        return atom.config.get('editor.preferredLineLength');
      }
      if (columns.length === 1) {
        return columns[0];
      }
      var maxLineLength = this.getMaxLineLength(range, textEditor);
      var maxCol = 0;
      for (var col of columns) {
        if (col < maxLineLength && col > maxCol) {
          maxCol = col;
        }
      }
      if (maxCol === 0) maxCol = max(columns);
      return maxCol;
    } catch (err) {
      return atom.config.get('editor.preferredLineLength');
    }
  },

  reflowSelection: function reflowSelection() {
    var _this2 = this;

    var editor = atom.workspace.getActiveTextEditor();
    editor.transact(function () {
      for (var range of editor.getSelectedBufferRanges()) {
        // Selection.selectToBeginningOfLine()
        // selection.selectToEndOfLine()
        if (range.isEmpty()) {
          range = editor.rowRangeForParagraphAtBufferRow(range.getRows()[0]);
          if (range == null) continue; // Nothing to do here
        }

        var reflowOptions = {
          wrapColumn: _this2.getWrapColumn(range, editor),
          tabLength: _this2.getTabLength(editor)
        };
        var reflowedText = _this2.reflow(editor.getTextInBufferRange(range), reflowOptions);
        editor.getBuffer().setTextInRange(range, reflowedText);
      }
    });
  },

  // "borrowed" from atom/autoflow
  // TODO: move this to a node module, submit PR to autoflow to use that.
  reflow: function reflow(text, _ref) {
    var _this3 = this;

    var wrapColumn = _ref.wrapColumn;
    var tabLength = _ref.tabLength;

    var paragraphs = [];
    // Convert all \r\n and \r to \n. the text buffer will normalise them later
    text = text.replace(/\r\n?/g, '\n');

    var paragraphBlocks = text.split(/\n\s*\n/g);
    var tabLengthInSpaces = tabLength == null ? '' : repeating(tabLength, ' ');

    var _loop = function (block) {
      // TODO: this could be more language specific. Use the actual comment char.
      var linePrefix = block.match(/^\s*[/#*-]*\s*/g)[0];
      var linePrefixTabExpanded = tabLength ? linePrefix.replace(/\t/g, tabLengthInSpaces) : linePrefix;
      var escapedLinePrefix = linePrefix && escapeRegExp(linePrefix);
      var blockLines = block.split('\n');

      if (linePrefix) {
        blockLines = blockLines.map(function (blockLine) {
          return blockLine.replace(new RegExp('^' + escapedLinePrefix), '');
        });
      }

      blockLines = blockLines.map(function (blockLine) {
        return blockLine.replace(/^\s+/, '');
      });

      var lines = [];
      var currentLine = [];
      var currentLineLength = linePrefixTabExpanded.length;

      var segments = _this3.segmentText(blockLines.join(' '));

      for (var segment of segments) {
        if (_this3.wrapSegment(segment, currentLineLength, wrapColumn)) {
          lines.push(linePrefix + currentLine.join(''));
          currentLine = [];
          currentLineLength = linePrefixTabExpanded.length;
        }
        currentLine.push(segment);
        currentLineLength += segment.length;
      }
      lines.push(linePrefix + currentLine.join(''));

      paragraphs.push(lines.join('\n').replace(/\s+\n/g, '\n'));
    };

    for (var block of paragraphBlocks) {
      _loop(block);
    }

    return paragraphs.join('\n\n');
  },

  getTabLength: function getTabLength(editor) {
    var tabLength = atom.config.get('editor.tabLength', { scope: editor.getRootScopeDescriptor() });
    return tabLength == null ? 2 : tabLength;
  },

  wrapSegment: function wrapSegment(segment, currentLineLength, wrapColumn) {
    return CHARACTER_RE.test(segment) && currentLineLength + segment.length > wrapColumn && (currentLineLength > 0 || segment.length < wrapColumn) && true;
  },

  segmentText: function segmentText(text) {
    var segments = [];
    var re = /[\s]+|[^\s]+/g;
    var match = undefined;
    while (match = re.exec(text)) segments.push(match[0]);
    return segments;
  }
};
/* English */ /* Cyrillic */
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy93aWxsL2RvdGZpbGVzLy5hdG9tL3BhY2thZ2VzL2hhcmQtd3JhcC9saWIvaGFyZC13cmFwLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJvQkFFa0MsTUFBTTs7QUFGeEMsV0FBVyxDQUFBOztBQUlYLElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0FBQ25ELElBQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQTs7QUFFdEMsU0FBUyxHQUFHLENBQUMsR0FBVSxFQUFFO0FBQ3ZCLFNBQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFDLEdBQUcsRUFBRSxJQUFJO1dBQUssSUFBSSxHQUFHLEdBQUcsR0FBRyxJQUFJLEdBQUcsR0FBRztHQUFBLEVBQUUsQ0FBQyxDQUFDLENBQUE7Q0FDN0Q7O0FBRUQsSUFBTSxZQUFZLEdBQUcsSUFBSSxNQUFNLDJCQUs3QixDQUFBOzs7QUFHRixNQUFNLENBQUMsT0FBTyxHQUFHO0FBQ2YsZUFBYSxFQUFFLElBQUk7O0FBRW5CLFVBQVEsRUFBQSxrQkFBQyxLQUFLLEVBQUU7OztBQUNkLFFBQUksQ0FBQyxhQUFhLEdBQUcsK0JBQXlCLENBQUE7OztBQUc5QyxRQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRTtBQUMzRCxrQ0FBNEIsRUFBRTtlQUFNLE1BQUssZUFBZSxFQUFFO09BQUE7S0FDM0QsQ0FBQyxDQUFDLENBQUE7R0FDSjs7QUFFRCxZQUFVLEVBQUEsc0JBQUc7QUFDWCxRQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFBO0dBQzdCOztBQUVELGtCQUFnQixFQUFBLDBCQUFDLEtBQUssRUFBRSxVQUFVLEVBQUU7QUFDbEMsUUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFBO0FBQ2QsU0FBSyxJQUFNLEdBQUcsSUFBSyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUMsT0FBTyxF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QWtCLEVBQUUsRUFBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLHNCQUFzQixFQUFFLEVBQUMsQ0FBQyxDQUFBO0FBQy9GLFdBQU8sU0FBUyxJQUFJLElBQUksR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFBO0dBQ3pDOztBQUVELGFBQVcsRUFBQSxxQkFBQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsVUFBVSxFQUFFO0FBQ2xELFdBQ0UsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFDekIsaUJBQWlCLEdBQUcsT0FBTyxDQUFDLE1BQU0sR0FBRyxVQUFVLEFBQUMsS0FDaEQsaUJBQWlCLEdBQUcsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFBLEFBQUMsSUFDeEQsSUFBSSxDQUFDO0dBQ047O0FBRUQsYUFBVyxFQUFBLHFCQUFDLElBQUksRUFBRTtBQUNoQixRQUFNLFFBQVEsR0FBRyxFQUFFLENBQUE7QUFDbkIsUUFBTSxFQUFFLEdBQUcsZUFBZSxDQUFBO0FBQzFCLFFBQUksS0FBSyxZQUFBLENBQUE7QUFDVCxXQUFRLEtBQUssR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDdkQsV0FBTyxRQUFRLENBQUE7R0FDaEI7Q0FDRixDQUFBIiwiZmlsZSI6Ii9Vc2Vycy93aWxsL2RvdGZpbGVzLy5hdG9tL3BhY2thZ2VzL2hhcmQtd3JhcC9saWIvaGFyZC13cmFwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcblxuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJ1xuXG5jb25zdCBlc2NhcGVSZWdFeHAgPSByZXF1aXJlKCdlc2NhcGUtcmVnZXgtc3RyaW5nJylcbmNvbnN0IHJlcGVhdGluZyA9IHJlcXVpcmUoJ3JlcGVhdGluZycpXG5cbmZ1bmN0aW9uIG1heChhcnI6IEFycmF5KSB7XG4gIHJldHVybiBhcnIucmVkdWNlKChjdXIsIG5leHQpID0+IG5leHQgPiBjdXIgPyBuZXh0IDogY3VyLCAwKVxufVxuXG5jb25zdCBDSEFSQUNURVJfUkUgPSBuZXcgUmVnRXhwKGBcXFxuW1xcXG5cXFxcdyR7LyogRW5nbGlzaCAqLycnfVxcXG5cXHUwNDEwLVxcdTA0MkZcXHUwNDAxXFx1MDQzMC1cXHUwNDRGXFx1MDQ1MSR7LyogQ3lyaWxsaWMgKi8nJ31cXFxuXVxcXG5gKVxuXG4vLyBBdG9tSGFyZFdyYXBcbm1vZHVsZS5leHBvcnRzID0ge1xuICBzdWJzY3JpcHRpb25zOiBudWxsLFxuXG4gIGFjdGl2YXRlKHN0YXRlKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gICAgLy8gUmVnaXN0ZXIgY29tbWFuZCB0aGF0IHRvZ2dsZXMgdGhpcyB2aWV3XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS10ZXh0LWVkaXRvcicsIHtcbiAgICAgICdoYXJkLXdyYXA6cmVmbG93LXNlbGVjdGlvbic6ICgpID0+IHRoaXMucmVmbG93U2VsZWN0aW9uKClcbiAgICB9KSlcbiAgfSxcblxuICBkZWFjdGl2YXRlKCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5kaXNwb3NlKClcbiAgfSxcblxuICBnZXRNYXhMaW5lTGVuZ3RoKHJhbmdlLCB0ZXh0RWRpdG9yKSB7XG4gICAgbGV0IG1heExlbiA9IDBcbiAgICBmb3IgKGNvbnN0IHJvdyBvZiAocmFuZ2UuZ2V0QnVmZmVyUmFuZ2UoKS5nZXRSb3dzKCk6IEFycmF5KSkge1xuICAgICAgY29uc3QgbGVuID0gdGV4dEVkaXRvci5saW5lVGV4dEZvckJ1ZmZlclJvdyhyb3cpLmxlbmd0aFxuICAgICAgaWYgKGxlbiA+IG1heExlbikge1xuICAgICAgICBtYXhMZW4gPSBsZW5cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG1heExlblxuICB9LFxuXG4gIGdldFdyYXBDb2x1bW4ocmFuZ2UsIHRleHRFZGl0b3IpIHtcbiAgICBpZiAoIWF0b20ucGFja2FnZXMuaXNQYWNrYWdlTG9hZGVkKCdtdWx0aS13cmFwLWd1aWRlJykpIHtcbiAgICAgIHJldHVybiBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5wcmVmZXJyZWRMaW5lTGVuZ3RoJywge3Njb3BlOiB0ZXh0RWRpdG9yLmdldFJvb3RTY29wZURlc2NyaXB0b3IoKX0pXG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRleHRFZGl0b3JWaWV3ID0gYXRvbS52aWV3cy5nZXRWaWV3KHRleHRFZGl0b3IpXG4gICAgICBjb25zdCB3cmFwR3VpZGVWaWV3ID1cbiAgICAgICAgdGV4dEVkaXRvclZpZXcucm9vdEVsZW1lbnQucXVlcnlTZWxlY3RvcignLm11bHRpLXdyYXAtZ3VpZGUtdmlldycpXG4gICAgICBjb25zdCBjb2x1bW5zID0gd3JhcEd1aWRlVmlldy5zcGFjZVBlblZpZXcuY29sdW1uc1xuICAgICAgaWYgKGNvbHVtbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5wcmVmZXJyZWRMaW5lTGVuZ3RoJylcbiAgICAgIH1cbiAgICAgIGlmIChjb2x1bW5zLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICByZXR1cm4gY29sdW1uc1swXVxuICAgICAgfVxuICAgICAgY29uc3QgbWF4TGluZUxlbmd0aCA9IHRoaXMuZ2V0TWF4TGluZUxlbmd0aChyYW5nZSwgdGV4dEVkaXRvcilcbiAgICAgIGxldCBtYXhDb2wgPSAwXG4gICAgICBmb3IgKGNvbnN0IGNvbCBvZiAoY29sdW1uczogQXJyYXkpKSB7XG4gICAgICAgIGlmIChjb2wgPCBtYXhMaW5lTGVuZ3RoICYmIGNvbCA+IG1heENvbCkge1xuICAgICAgICAgIG1heENvbCA9IGNvbFxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAobWF4Q29sID09PSAwKSBtYXhDb2wgPSBtYXgoY29sdW1ucylcbiAgICAgIHJldHVybiBtYXhDb2xcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5wcmVmZXJyZWRMaW5lTGVuZ3RoJylcbiAgICB9XG4gIH0sXG5cbiAgcmVmbG93U2VsZWN0aW9uKCkge1xuICAgIGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKVxuICAgIGVkaXRvci50cmFuc2FjdCgoKSA9PiB7XG4gICAgICBmb3IgKGxldCByYW5nZSBvZiAoZWRpdG9yLmdldFNlbGVjdGVkQnVmZmVyUmFuZ2VzKCk6IEFycmF5KSkge1xuICAgICAgICAvLyBTZWxlY3Rpb24uc2VsZWN0VG9CZWdpbm5pbmdPZkxpbmUoKVxuICAgICAgICAvLyBzZWxlY3Rpb24uc2VsZWN0VG9FbmRPZkxpbmUoKVxuICAgICAgICBpZiAocmFuZ2UuaXNFbXB0eSgpKSB7XG4gICAgICAgICAgcmFuZ2UgPSBlZGl0b3Iucm93UmFuZ2VGb3JQYXJhZ3JhcGhBdEJ1ZmZlclJvdyhyYW5nZS5nZXRSb3dzKClbMF0pXG4gICAgICAgICAgaWYgKHJhbmdlID09IG51bGwpIGNvbnRpbnVlIC8vIE5vdGhpbmcgdG8gZG8gaGVyZVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVmbG93T3B0aW9ucyA9IHtcbiAgICAgICAgICB3cmFwQ29sdW1uOiB0aGlzLmdldFdyYXBDb2x1bW4ocmFuZ2UsIGVkaXRvciksXG4gICAgICAgICAgdGFiTGVuZ3RoOiB0aGlzLmdldFRhYkxlbmd0aChlZGl0b3IpLFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlZmxvd2VkVGV4dCA9IHRoaXMucmVmbG93KGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShyYW5nZSksIHJlZmxvd09wdGlvbnMpXG4gICAgICAgIGVkaXRvci5nZXRCdWZmZXIoKS5zZXRUZXh0SW5SYW5nZShyYW5nZSwgcmVmbG93ZWRUZXh0KVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG5cbiAgLy8gXCJib3Jyb3dlZFwiIGZyb20gYXRvbS9hdXRvZmxvd1xuICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gYSBub2RlIG1vZHVsZSwgc3VibWl0IFBSIHRvIGF1dG9mbG93IHRvIHVzZSB0aGF0LlxuICByZWZsb3codGV4dCwge3dyYXBDb2x1bW4sIHRhYkxlbmd0aH0pIHtcbiAgICBjb25zdCBwYXJhZ3JhcGhzID0gW11cbiAgICAvLyBDb252ZXJ0IGFsbCBcXHJcXG4gYW5kIFxcciB0byBcXG4uIHRoZSB0ZXh0IGJ1ZmZlciB3aWxsIG5vcm1hbGlzZSB0aGVtIGxhdGVyXG4gICAgdGV4dCA9IHRleHQucmVwbGFjZSgvXFxyXFxuPy9nLCAnXFxuJylcblxuICAgIGNvbnN0IHBhcmFncmFwaEJsb2NrcyA9IHRleHQuc3BsaXQoL1xcblxccypcXG4vZylcbiAgICBjb25zdCB0YWJMZW5ndGhJblNwYWNlcyA9IHRhYkxlbmd0aCA9PSBudWxsID8gJycgOiByZXBlYXRpbmcodGFiTGVuZ3RoLCAnICcpXG5cbiAgICBmb3IgKGNvbnN0IGJsb2NrIG9mIChwYXJhZ3JhcGhCbG9ja3M6IEFycmF5KSkge1xuICAgICAgLy8gVE9ETzogdGhpcyBjb3VsZCBiZSBtb3JlIGxhbmd1YWdlIHNwZWNpZmljLiBVc2UgdGhlIGFjdHVhbCBjb21tZW50IGNoYXIuXG4gICAgICBjb25zdCBsaW5lUHJlZml4ID0gYmxvY2subWF0Y2goL15cXHMqWy8jKi1dKlxccyovZylbMF1cbiAgICAgIGNvbnN0IGxpbmVQcmVmaXhUYWJFeHBhbmRlZCA9IHRhYkxlbmd0aCA/IGxpbmVQcmVmaXgucmVwbGFjZSgvXFx0L2csIHRhYkxlbmd0aEluU3BhY2VzKSA6IGxpbmVQcmVmaXhcbiAgICAgIGNvbnN0IGVzY2FwZWRMaW5lUHJlZml4ID0gbGluZVByZWZpeCAmJiBlc2NhcGVSZWdFeHAobGluZVByZWZpeClcbiAgICAgIGxldCBibG9ja0xpbmVzID0gYmxvY2suc3BsaXQoJ1xcbicpXG5cbiAgICAgIGlmIChsaW5lUHJlZml4KSB7XG4gICAgICAgIGJsb2NrTGluZXMgPSBibG9ja0xpbmVzLm1hcCgoYmxvY2tMaW5lKSA9PlxuICAgICAgICAgIGJsb2NrTGluZS5yZXBsYWNlKG5ldyBSZWdFeHAoYF4ke2VzY2FwZWRMaW5lUHJlZml4fWApLCAnJylcbiAgICAgICAgKVxuICAgICAgfVxuXG4gICAgICBibG9ja0xpbmVzID0gYmxvY2tMaW5lcy5tYXAoKGJsb2NrTGluZSkgPT4gYmxvY2tMaW5lLnJlcGxhY2UoL15cXHMrLywgJycpKVxuXG4gICAgICBjb25zdCBsaW5lcyA9IFtdXG4gICAgICBsZXQgY3VycmVudExpbmUgPSBbXVxuICAgICAgbGV0IGN1cnJlbnRMaW5lTGVuZ3RoID0gbGluZVByZWZpeFRhYkV4cGFuZGVkLmxlbmd0aFxuXG4gICAgICBjb25zdCBzZWdtZW50cyA9IHRoaXMuc2VnbWVudFRleHQoYmxvY2tMaW5lcy5qb2luKCcgJykpXG5cbiAgICAgIGZvciAoY29uc3Qgc2VnbWVudCBvZiAoc2VnbWVudHM6IEFycmF5KSkge1xuICAgICAgICBpZiAodGhpcy53cmFwU2VnbWVudChzZWdtZW50LCBjdXJyZW50TGluZUxlbmd0aCwgd3JhcENvbHVtbikpIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKGxpbmVQcmVmaXggKyBjdXJyZW50TGluZS5qb2luKCcnKSlcbiAgICAgICAgICBjdXJyZW50TGluZSA9IFtdXG4gICAgICAgICAgY3VycmVudExpbmVMZW5ndGggPSBsaW5lUHJlZml4VGFiRXhwYW5kZWQubGVuZ3RoXG4gICAgICAgIH1cbiAgICAgICAgY3VycmVudExpbmUucHVzaChzZWdtZW50KVxuICAgICAgICBjdXJyZW50TGluZUxlbmd0aCArPSBzZWdtZW50Lmxlbmd0aFxuICAgICAgfVxuICAgICAgbGluZXMucHVzaChsaW5lUHJlZml4ICsgY3VycmVudExpbmUuam9pbignJykpXG5cbiAgICAgIHBhcmFncmFwaHMucHVzaChsaW5lcy5qb2luKCdcXG4nKS5yZXBsYWNlKC9cXHMrXFxuL2csICdcXG4nKSlcbiAgICB9XG5cbiAgICByZXR1cm4gcGFyYWdyYXBocy5qb2luKCdcXG5cXG4nKVxuICB9LFxuXG4gIGdldFRhYkxlbmd0aChlZGl0b3IpIHtcbiAgICBjb25zdCB0YWJMZW5ndGggPSBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci50YWJMZW5ndGgnLCB7c2NvcGU6IGVkaXRvci5nZXRSb290U2NvcGVEZXNjcmlwdG9yKCl9KVxuICAgIHJldHVybiB0YWJMZW5ndGggPT0gbnVsbCA/IDIgOiB0YWJMZW5ndGhcbiAgfSxcblxuICB3cmFwU2VnbWVudChzZWdtZW50LCBjdXJyZW50TGluZUxlbmd0aCwgd3JhcENvbHVtbikge1xuICAgIHJldHVybiAoXG4gICAgICBDSEFSQUNURVJfUkUudGVzdChzZWdtZW50KSAmJlxuICAgICAgKGN1cnJlbnRMaW5lTGVuZ3RoICsgc2VnbWVudC5sZW5ndGggPiB3cmFwQ29sdW1uKSAmJlxuICAgICAgKGN1cnJlbnRMaW5lTGVuZ3RoID4gMCB8fCBzZWdtZW50Lmxlbmd0aCA8IHdyYXBDb2x1bW4pICYmXG4gICAgdHJ1ZSlcbiAgfSxcblxuICBzZWdtZW50VGV4dCh0ZXh0KSB7XG4gICAgY29uc3Qgc2VnbWVudHMgPSBbXVxuICAgIGNvbnN0IHJlID0gL1tcXHNdK3xbXlxcc10rL2dcbiAgICBsZXQgbWF0Y2hcbiAgICB3aGlsZSAoKG1hdGNoID0gcmUuZXhlYyh0ZXh0KSkpIHNlZ21lbnRzLnB1c2gobWF0Y2hbMF0pXG4gICAgcmV0dXJuIHNlZ21lbnRzXG4gIH0sXG59XG4iXX0=