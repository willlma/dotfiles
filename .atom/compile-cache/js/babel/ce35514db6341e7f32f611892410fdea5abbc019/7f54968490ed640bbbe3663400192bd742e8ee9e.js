Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.activate = activate;
exports.deactivate = deactivate;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _atom = require('atom');

var _coreJsLibrary = require('core-js/library');

var _coreJsLibrary2 = _interopRequireDefault(_coreJsLibrary);

'use babel';

var find = _coreJsLibrary2['default'].Array.prototype.find;

var disposables = [];

var Lang = function Lang(rLangScope, openCommentToken, closeCommentToken) {
  return {
    test: function test(scope) {
      return rLangScope.test(scope);
    },
    commentTokens: { open: openCommentToken, close: closeCommentToken }
  };
};
var langs = [Lang(/^source\.js\.?/, '/*', '*/'), Lang(/^source\.css\.?/, '/*', '*/'), Lang(/^source\.php\.?/, '/*', '*/'), Lang(/^text\.html\.?/, '<!--', '-->'), Lang(/^source\.python\.?/, "'''", "'''")];

var config = {
  pad: {
    title: 'Pad with spaces',
    description: 'Pad selection with whitespace when commenting.',
    type: 'boolean',
    'default': false
  }
};

exports.config = config;

function activate() {
  disposables.push(atom.commands.add('atom-text-editor:not([mini])', { 'sublime-block-comment:toggle': toggle }));
}

function deactivate() {
  for (var disposable of disposables) {
    disposable.dispose();
  }disposables.length = 0;
}

function toggle() {
  var editor = atom.workspace.getActiveTextEditor();
  if (!editor) return;

  var buffer = editor.getBuffer();
  var padding = atom.config.get('sublime-block-comment.pad') ? ' ' : '';

  buffer.transact(function () {
    for (var selection of editor.getSelectionsOrderedByBufferPosition().reverse()) {
      var range = selection.getBufferRange();
      var textInRange = buffer.getTextInRange(range);
      var scopes = getPositionScopes(range.start).reverse();

      var lang = undefined;
      if (!scopes.some(function (scope) {
        return lang = find.call(langs, function (lang) {
          return lang.test(scope);
        });
      })) lang = langs[0];
      var commentTokens = lang.commentTokens;

      // If we are inside a block comment or have one fully or partially selected, uncomment it.
      if ((isInsideBlockComment(range.start) || isAtCloseCommentToken(range.start, commentTokens.close)) && (isInsideBlockComment(range.end) || isAtCloseCommentToken(range.end, commentTokens.close)) && ~[-1, textInRange.length - commentTokens.close.length].indexOf(textInRange.indexOf(commentTokens.close))) {
        var blockCommentCloseRange = undefined;
        var lastRow = buffer.getLastRow();
        for (var row = range.end.row; !blockCommentCloseRange && row <= lastRow; row++) {
          var line = buffer.lineForRow(row);
          for (var column = row === range.end.row ? Math.max(range.end.column - commentTokens.close.length + (
          // Python has the same tokens for block string begin and end, so we need an extra sanity check.
          // This logic would not work with JavaScript anyway as it the comment begin/end tokens don't have dedicated scopes.
          isPythonStringBlockBegin(range.end) ? commentTokens.open.length + 1 : 0), 0) : 0; (column = line.indexOf(commentTokens.close, column)) !== -1; column++) {
            if (isCommentDefinitionPunctuation([row, column])) {
              blockCommentCloseRange = new _atom.Range([row, column], [row, column + commentTokens.close.length]);
              break;
            }
          }
        }

        var blockCommentOpenRange = undefined;
        for (var row = range.start.row; !blockCommentOpenRange && row >= 0; row--) {
          var line = buffer.lineForRow(row);
          for (var column = row === range.start.row ? blockCommentCloseRange && row === blockCommentCloseRange.start.row
          // Python has the same tokens for block string begin and end, so we need an extra sanity check.
          // If end token is at the beginning of a line (column 0), skip to the line above to avoid matching the end token as the begin token as well.
          ? blockCommentCloseRange.start.column - 1 > 0 ? blockCommentCloseRange.start.column - 1 : (--row, line = buffer.lineForRow(row), line.length) : Math.min(range.start.column + commentTokens.open.length, line.length) : line.length; (column = line.lastIndexOf(commentTokens.open, column)) !== -1; column--) {
            if (isCommentDefinitionPunctuation([row, column])) {
              blockCommentOpenRange = new _atom.Range([row, column], [row, column + commentTokens.open.length]);
              break;
            }
          }
        }

        if (blockCommentCloseRange) {
          if (padding) {
            var blockCommentClosePaddedRangeStart = new _atom.Point(blockCommentCloseRange.start.row, blockCommentCloseRange.start.column - padding.length);
            if ((!blockCommentOpenRange || blockCommentClosePaddedRangeStart.compare(blockCommentOpenRange.end) >= 0) && buffer.getTextInRange([blockCommentClosePaddedRangeStart, blockCommentCloseRange.start]) === padding) {
              blockCommentCloseRange.start = blockCommentClosePaddedRangeStart;
            }
          }
          buffer['delete'](blockCommentCloseRange);
        }

        if (blockCommentOpenRange) {
          if (padding) {
            var blockCommentOpenPaddedRangeEnd = new _atom.Point(blockCommentOpenRange.end.row, blockCommentOpenRange.end.column + padding.length);
            if (
            // This sanity check also prevents excessively removing "overlapping" start/end padding.
            // E.g.: "/* */ a" => " a" instead of "a"
            (!blockCommentCloseRange || blockCommentOpenPaddedRangeEnd.compare(blockCommentCloseRange.start) <= 0) && buffer.getTextInRange([blockCommentOpenRange.end, blockCommentOpenPaddedRangeEnd]) === padding) {
              blockCommentOpenRange.end = blockCommentOpenPaddedRangeEnd;
            }
          }
          buffer['delete'](blockCommentOpenRange);
        }

        continue;
      }

      // Else, wrap selection with block comment.
      buffer.insert(range.end, padding + commentTokens.close);
      buffer.insert(range.start, commentTokens.open + padding);

      // Unselect the opening and closing comment tokens.
      var startRowColumnOffset = commentTokens.open.length + padding.length;
      selection.setBufferRange([[range.start.row, range.start.column + startRowColumnOffset], [range.end.row, range.end.column + (range.start.row === range.end.row ? startRowColumnOffset : 0)]]);
    }
  });

  function isInsideBlockComment(position) {
    var scopes = getPositionScopes(position);
    var commentScopePrefix = (isPythonSource(scopes) ? 'string.quoted.single' : 'comment') + '.block.';
    return scopes.some(function (scope) {
      return scope.startsWith(commentScopePrefix);
    });
  }

  function isCommentDefinitionPunctuation(position) {
    var scopes = getPositionScopes(position);
    var commentPunctuationScopePrefix = 'punctuation.definition.' + (isPythonSource(scopes) ? 'string' : 'comment') + '.';
    return scopes.some(function (scope) {
      return scope.startsWith(commentPunctuationScopePrefix);
    });
  }

  function getPositionScopes(position) {
    return editor.scopeDescriptorForBufferPosition(position).getScopesArray();
  }

  function isAtCloseCommentToken(position, closeCommentToken) {
    return position.column >= closeCommentToken.length && buffer.getTextInRange([[position.row, position.column - closeCommentToken.length], position]) === closeCommentToken && isCommentDefinitionPunctuation([position.row, position.column - 1]);
  }

  function isPythonSource(scopes) {
    return scopes[0] === 'source.python';
  }

  function isPythonPunctuationDefinitionStringBegin(scope) {
    return scope === 'punctuation.definition.string.begin.python';
  }

  function isPythonStringBlockBegin(position) {
    return isInsideBlockComment(position) && (getPositionScopes(position).some(isPythonPunctuationDefinitionStringBegin) ||
    // Atom does not identify the position at the end of the begin token as part of its scope, therefore we check one column to the left as well.
    position.column > 0 && getPositionScopes([position.row, position.column - 1]).some(isPythonPunctuationDefinitionStringBegin));
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy93aWxsL2RvdGZpbGVzLy5hdG9tL3BhY2thZ2VzL3N1YmxpbWUtYmxvY2stY29tbWVudC9saWIvc3VibGltZS1ibG9jay1jb21tZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O29CQUU2QixNQUFNOzs2QkFFbEIsaUJBQWlCOzs7O0FBSmxDLFdBQVcsQ0FBQzs7SUFLSixJQUFJLEdBQUssMkJBQUssS0FBSyxDQUFDLFNBQVMsQ0FBN0IsSUFBSTs7QUFFWixJQUFNLFdBQVcsR0FBRyxFQUFFLENBQUM7O0FBRXZCLElBQU0sSUFBSSxHQUFHLFNBQVAsSUFBSSxDQUFJLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxpQkFBaUI7U0FBTTtBQUNqRSxRQUFJLEVBQUUsY0FBQyxLQUFLO2FBQUssVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7S0FBQTtBQUN2QyxpQkFBYSxFQUFFLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxpQkFBaUIsRUFBRTtHQUNwRTtDQUFDLENBQUM7QUFDSCxJQUFNLEtBQUssR0FBRyxDQUNaLElBQUksQ0FBQyxnQkFBZ0IsRUFBSyxJQUFJLEVBQUksSUFBSSxDQUFFLEVBQ3hDLElBQUksQ0FBQyxpQkFBaUIsRUFBSSxJQUFJLEVBQUksSUFBSSxDQUFFLEVBQ3hDLElBQUksQ0FBQyxpQkFBaUIsRUFBSSxJQUFJLEVBQUksSUFBSSxDQUFFLEVBQ3hDLElBQUksQ0FBQyxnQkFBZ0IsRUFBSyxNQUFNLEVBQUUsS0FBSyxDQUFDLEVBQ3hDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQ3pDLENBQUM7O0FBRUssSUFBTSxNQUFNLEdBQUc7QUFDcEIsS0FBRyxFQUFFO0FBQ0gsU0FBSyxFQUFFLGlCQUFpQjtBQUN4QixlQUFXLEVBQUUsZ0RBQWdEO0FBQzdELFFBQUksRUFBRSxTQUFTO0FBQ2YsZUFBUyxLQUFLO0dBQ2Y7Q0FDRixDQUFDOzs7O0FBRUss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QU0sQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLEtBQUssaUJBQWlCLElBQ25ILDhCQUE4QixDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7R0FDMUU7O0FBRUQsV0FBUyxjQUFjLENBQUMsTUFBTSxFQUFFO0FBQzlCLFdBQU8sTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLGVBQWUsQ0FBQztHQUN0Qzs7QUFFRCxXQUFTLHdDQUF3QyxDQUFDLEtBQUssRUFBRTtBQUN2RCxXQUFPLEtBQUssS0FBSyw0Q0FBNEMsQ0FBQztHQUMvRDs7QUFFRCxXQUFTLHdCQUF3QixDQUFDLFFBQVEsRUFBRTtBQUMxQyxXQUFPLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxLQUNuQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsd0NBQXdDLENBQUM7O0FBRXpFLFlBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLGlCQUFpQixDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLHdDQUF3QyxDQUFDLENBQUMsQUFDL0gsQ0FBQztHQUNIO0NBQ0YiLCJmaWxlIjoiL1VzZXJzL3dpbGwvZG90ZmlsZXMvLmF0b20vcGFja2FnZXMvc3VibGltZS1ibG9jay1jb21tZW50L2xpYi9zdWJsaW1lLWJsb2NrLWNvbW1lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IHsgUG9pbnQsIFJhbmdlIH0gZnJvbSAnYXRvbSc7XG5cbmltcG9ydCBjb3JlIGZyb20gJ2NvcmUtanMvbGlicmFyeSc7XG5jb25zdCB7IGZpbmQgfSA9IGNvcmUuQXJyYXkucHJvdG90eXBlO1xuXG5jb25zdCBkaXNwb3NhYmxlcyA9IFtdO1xuXG5jb25zdCBMYW5nID0gKHJMYW5nU2NvcGUsIG9wZW5Db21tZW50VG9rZW4sIGNsb3NlQ29tbWVudFRva2VuKSA9PiAoe1xuICB0ZXN0OiAoc2NvcGUpID0+IHJMYW5nU2NvcGUudGVzdChzY29wZSksXG4gIGNvbW1lbnRUb2tlbnM6IHsgb3Blbjogb3BlbkNvbW1lbnRUb2tlbiwgY2xvc2U6IGNsb3NlQ29tbWVudFRva2VuIH0sXG59KTtcbmNvbnN0IGxhbmdzID0gW1xuICBMYW5nKC9ec291cmNlXFwuanNcXC4/LyAsICAgJy8qJyAgLCAnKi8nICksXG4gIExhbmcoL15zb3VyY2VcXC5jc3NcXC4/LywgICAnLyonICAsICcqLycgKSxcbiAgTGFuZygvXnNvdXJjZVxcLnBocFxcLj8vLCAgICcvKicgICwgJyovJyApLFxuICBMYW5nKC9edGV4dFxcLmh0bWxcXC4/LyAsICAgJzwhLS0nLCAnLS0+JyksXG4gIExhbmcoL15zb3VyY2VcXC5weXRob25cXC4/LywgXCInJydcIiwgXCInJydcIiksXG5dO1xuXG5leHBvcnQgY29uc3QgY29uZmlnID0ge1xuICBwYWQ6IHtcbiAgICB0aXRsZTogJ1BhZCB3aXRoIHNwYWNlcycsXG4gICAgZGVzY3JpcHRpb246ICdQYWQgc2VsZWN0aW9uIHdpdGggd2hpdGVzcGFjZSB3aGVuIGNvbW1lbnRpbmcuJyxcbiAgICB0eXBlOiAnYm9vbGVhbicsXG4gICAgZGVmYXVsdDogZmFsc2UsXG4gIH0sXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gYWN0aXZhdGUoKSB7XG4gIGRpc3Bvc2FibGVzLnB1c2goYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3I6bm90KFttaW5pXSknLCB7ICdzdWJsaW1lLWJsb2NrLWNvbW1lbnQ6dG9nZ2xlJzogdG9nZ2xlIH0pKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUoKSB7XG4gIGZvciAoY29uc3QgZGlzcG9zYWJsZSBvZiBkaXNwb3NhYmxlcykgZGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gIGRpc3Bvc2FibGVzLmxlbmd0aCA9IDA7XG59XG5cbmZ1bmN0aW9uIHRvZ2dsZSgpIHtcbiAgY29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICBpZiAoIWVkaXRvcikgcmV0dXJuO1xuXG4gIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgY29uc3QgcGFkZGluZyA9IGF0b20uY29uZmlnLmdldCgnc3VibGltZS1ibG9jay1jb21tZW50LnBhZCcpID8gJyAnIDogJyc7XG5cbiAgYnVmZmVyLnRyYW5zYWN0KCgpID0+IHtcbiAgICBmb3IgKGNvbnN0IHNlbGVjdGlvbiBvZiBlZGl0b3IuZ2V0U2VsZWN0aW9uc09yZGVyZWRCeUJ1ZmZlclBvc2l0aW9uKCkucmV2ZXJzZSgpKSB7XG4gICAgICBjb25zdCByYW5nZSA9IHNlbGVjdGlvbi5nZXRCdWZmZXJSYW5nZSgpO1xuICAgICAgY29uc3QgdGV4dEluUmFuZ2UgPSBidWZmZXIuZ2V0VGV4dEluUmFuZ2UocmFuZ2UpO1xuICAgICAgY29uc3Qgc2NvcGVzID0gZ2V0UG9zaXRpb25TY29wZXMocmFuZ2Uuc3RhcnQpLnJldmVyc2UoKTtcblxuICAgICAgbGV0IGxhbmc7XG4gICAgICBpZiAoIXNjb3Blcy5zb21lKChzY29wZSkgPT4gbGFuZyA9IGxhbmdzOjpmaW5kKChsYW5nKSA9PiBsYW5nLnRlc3Qoc2NvcGUpKSkpIGxhbmcgPSBsYW5nc1swXTtcbiAgICAgIGNvbnN0IGNvbW1lbnRUb2tlbnMgPSBsYW5nLmNvbW1lbnRUb2tlbnM7XG5cbiAgICAgIC8vIElmIHdlIGFyZSBpbnNpZGUgYSBibG9jayBjb21tZW50IG9yIGhhdmUgb25lIGZ1bGx5IG9yIHBhcnRpYWxseSBzZWxlY3RlZCwgdW5jb21tZW50IGl0LlxuICAgICAgaWYgKFxuICAgICAgICAoaXNJbnNpZGVCbG9ja0NvbW1lbnQocmFuZ2Uuc3RhcnQpIHx8IGlzQXRDbG9zZUNvbW1lbnRUb2tlbihyYW5nZS5zdGFydCwgY29tbWVudFRva2Vucy5jbG9zZSkpXG4gICAgICAgICYmIChpc0luc2lkZUJsb2NrQ29tbWVudChyYW5nZS5lbmQpIHx8IGlzQXRDbG9zZUNvbW1lbnRUb2tlbihyYW5nZS5lbmQsIGNvbW1lbnRUb2tlbnMuY2xvc2UpKVxuICAgICAgICAmJiB+Wy0xLCB0ZXh0SW5SYW5nZS5sZW5ndGggLSBjb21tZW50VG9rZW5zLmNsb3NlLmxlbmd0aF0uaW5kZXhPZih0ZXh0SW5SYW5nZS5pbmRleE9mKGNvbW1lbnRUb2tlbnMuY2xvc2UpKVxuICAgICAgKSB7XG4gICAgICAgIGxldCBibG9ja0NvbW1lbnRDbG9zZVJhbmdlO1xuICAgICAgICBjb25zdCBsYXN0Um93ID0gYnVmZmVyLmdldExhc3RSb3coKTtcbiAgICAgICAgZm9yIChsZXQgcm93ID0gcmFuZ2UuZW5kLnJvdzsgIWJsb2NrQ29tbWVudENsb3NlUmFuZ2UgJiYgcm93IDw9IGxhc3RSb3c7IHJvdysrKSB7XG4gICAgICAgICAgY29uc3QgbGluZSA9IGJ1ZmZlci5saW5lRm9yUm93KHJvdyk7XG4gICAgICAgICAgZm9yIChcbiAgICAgICAgICAgIGxldCBjb2x1bW4gPSByb3cgPT09IHJhbmdlLmVuZC5yb3dcbiAgICAgICAgICAgICAgPyBNYXRoLm1heChyYW5nZS5lbmQuY29sdW1uIC0gY29tbWVudFRva2Vucy5jbG9zZS5sZW5ndGggKyAoXG4gICAgICAgICAgICAgICAgLy8gUHl0aG9uIGhhcyB0aGUgc2FtZSB0b2tlbnMgZm9yIGJsb2NrIHN0cmluZyBiZWdpbiBhbmQgZW5kLCBzbyB3ZSBuZWVkIGFuIGV4dHJhIHNhbml0eSBjaGVjay5cbiAgICAgICAgICAgICAgICAvLyBUaGlzIGxvZ2ljIHdvdWxkIG5vdCB3b3JrIHdpdGggSmF2YVNjcmlwdCBhbnl3YXkgYXMgaXQgdGhlIGNvbW1lbnQgYmVnaW4vZW5kIHRva2VucyBkb24ndCBoYXZlIGRlZGljYXRlZCBzY29wZXMuXG4gICAgICAgICAgICAgICAgaXNQeXRob25TdHJpbmdCbG9ja0JlZ2luKHJhbmdlLmVuZClcbiAgICAgICAgICAgICAgICAgID8gY29tbWVudFRva2Vucy5vcGVuLmxlbmd0aCArIDFcbiAgICAgICAgICAgICAgICAgIDogMFxuICAgICAgICAgICAgICApLCAwKVxuICAgICAgICAgICAgICA6IDA7XG4gICAgICAgICAgICAoY29sdW1uID0gbGluZS5pbmRleE9mKGNvbW1lbnRUb2tlbnMuY2xvc2UsIGNvbHVtbikpICE9PSAtMTtcbiAgICAgICAgICAgIGNvbHVtbisrXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBpZiAoaXNDb21tZW50RGVmaW5pdGlvblB1bmN0dWF0aW9uKFtyb3csIGNvbHVtbl0pKSB7XG4gICAgICAgICAgICAgIGJsb2NrQ29tbWVudENsb3NlUmFuZ2UgPSBuZXcgUmFuZ2UoW3JvdywgY29sdW1uXSwgW3JvdywgY29sdW1uICsgY29tbWVudFRva2Vucy5jbG9zZS5sZW5ndGhdKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJsb2NrQ29tbWVudE9wZW5SYW5nZTtcbiAgICAgICAgZm9yIChsZXQgcm93ID0gcmFuZ2Uuc3RhcnQucm93OyAhYmxvY2tDb21tZW50T3BlblJhbmdlICYmIHJvdyA+PSAwOyByb3ctLSkge1xuICAgICAgICAgIGxldCBsaW5lID0gYnVmZmVyLmxpbmVGb3JSb3cocm93KTtcbiAgICAgICAgICBmb3IgKFxuICAgICAgICAgICAgbGV0IGNvbHVtbiA9IHJvdyA9PT0gcmFuZ2Uuc3RhcnQucm93XG4gICAgICAgICAgICAgID8gKFxuICAgICAgICAgICAgICAgIGJsb2NrQ29tbWVudENsb3NlUmFuZ2UgJiYgcm93ID09PSBibG9ja0NvbW1lbnRDbG9zZVJhbmdlLnN0YXJ0LnJvd1xuICAgICAgICAgICAgICAgICAgLy8gUHl0aG9uIGhhcyB0aGUgc2FtZSB0b2tlbnMgZm9yIGJsb2NrIHN0cmluZyBiZWdpbiBhbmQgZW5kLCBzbyB3ZSBuZWVkIGFuIGV4dHJhIHNhbml0eSBjaGVjay5cbiAgICAgICAgICAgICAgICAgIC8vIElmIGVuZCB0b2tlbiBpcyBhdCB0aGUgYmVnaW5uaW5nIG9mIGEgbGluZSAoY29sdW1uIDApLCBza2lwIHRvIHRoZSBsaW5lIGFib3ZlIHRvIGF2b2lkIG1hdGNoaW5nIHRoZSBlbmQgdG9rZW4gYXMgdGhlIGJlZ2luIHRva2VuIGFzIHdlbGwuXG4gICAgICAgICAgICAgICAgICA/IChibG9ja0NvbW1lbnRDbG9zZVJhbmdlLnN0YXJ0LmNvbHVtbiAtIDEgPiAwID8gYmxvY2tDb21tZW50Q2xvc2VSYW5nZS5zdGFydC5jb2x1bW4gLSAxIDogKC0tcm93LCBsaW5lID0gYnVmZmVyLmxpbmVGb3JSb3cocm93KSwgbGluZS5sZW5ndGgpKVxuICAgICAgICAgICAgICAgICAgOiBNYXRoLm1pbihyYW5nZS5zdGFydC5jb2x1bW4gKyBjb21tZW50VG9rZW5zLm9wZW4ubGVuZ3RoLCBsaW5lLmxlbmd0aClcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICA6IGxpbmUubGVuZ3RoO1xuICAgICAgICAgICAgKGNvbHVtbiA9IGxpbmUubGFzdEluZGV4T2YoY29tbWVudFRva2Vucy5vcGVuLCBjb2x1bW4pKSAhPT0gLTE7XG4gICAgICAgICAgICBjb2x1bW4tLVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgaWYgKGlzQ29tbWVudERlZmluaXRpb25QdW5jdHVhdGlvbihbcm93LCBjb2x1bW5dKSkge1xuICAgICAgICAgICAgICBibG9ja0NvbW1lbnRPcGVuUmFuZ2UgPSBuZXcgUmFuZ2UoW3JvdywgY29sdW1uXSwgW3JvdywgY29sdW1uICsgY29tbWVudFRva2Vucy5vcGVuLmxlbmd0aF0pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYmxvY2tDb21tZW50Q2xvc2VSYW5nZSkge1xuICAgICAgICAgIGlmIChwYWRkaW5nKSB7XG4gICAgICAgICAgICBjb25zdCBibG9ja0NvbW1lbnRDbG9zZVBhZGRlZFJhbmdlU3RhcnQgPSBuZXcgUG9pbnQoYmxvY2tDb21tZW50Q2xvc2VSYW5nZS5zdGFydC5yb3csIGJsb2NrQ29tbWVudENsb3NlUmFuZ2Uuc3RhcnQuY29sdW1uIC0gcGFkZGluZy5sZW5ndGgpO1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAoIWJsb2NrQ29tbWVudE9wZW5SYW5nZSB8fCBibG9ja0NvbW1lbnRDbG9zZVBhZGRlZFJhbmdlU3RhcnQuY29tcGFyZShibG9ja0NvbW1lbnRPcGVuUmFuZ2UuZW5kKSA+PSAwKVxuICAgICAgICAgICAgICAmJiBidWZmZXIuZ2V0VGV4dEluUmFuZ2UoW2Jsb2NrQ29tbWVudENsb3NlUGFkZGVkUmFuZ2VTdGFydCwgYmxvY2tDb21tZW50Q2xvc2VSYW5nZS5zdGFydF0pID09PSBwYWRkaW5nXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgYmxvY2tDb21tZW50Q2xvc2VSYW5nZS5zdGFydCA9IGJsb2NrQ29tbWVudENsb3NlUGFkZGVkUmFuZ2VTdGFydDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgYnVmZmVyLmRlbGV0ZShibG9ja0NvbW1lbnRDbG9zZVJhbmdlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChibG9ja0NvbW1lbnRPcGVuUmFuZ2UpIHtcbiAgICAgICAgICBpZiAocGFkZGluZykge1xuICAgICAgICAgICAgY29uc3QgYmxvY2tDb21tZW50T3BlblBhZGRlZFJhbmdlRW5kID0gbmV3IFBvaW50KGJsb2NrQ29tbWVudE9wZW5SYW5nZS5lbmQucm93LCBibG9ja0NvbW1lbnRPcGVuUmFuZ2UuZW5kLmNvbHVtbiArIHBhZGRpbmcubGVuZ3RoKTtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgLy8gVGhpcyBzYW5pdHkgY2hlY2sgYWxzbyBwcmV2ZW50cyBleGNlc3NpdmVseSByZW1vdmluZyBcIm92ZXJsYXBwaW5nXCIgc3RhcnQvZW5kIHBhZGRpbmcuXG4gICAgICAgICAgICAgIC8vIEUuZy46IFwiLyogKi8gYVwiID0+IFwiIGFcIiBpbnN0ZWFkIG9mIFwiYVwiXG4gICAgICAgICAgICAgICghYmxvY2tDb21tZW50Q2xvc2VSYW5nZSB8fCBibG9ja0NvbW1lbnRPcGVuUGFkZGVkUmFuZ2VFbmQuY29tcGFyZShibG9ja0NvbW1lbnRDbG9zZVJhbmdlLnN0YXJ0KSA8PSAwKVxuICAgICAgICAgICAgICAmJiBidWZmZXIuZ2V0VGV4dEluUmFuZ2UoW2Jsb2NrQ29tbWVudE9wZW5SYW5nZS5lbmQsIGJsb2NrQ29tbWVudE9wZW5QYWRkZWRSYW5nZUVuZF0pID09PSBwYWRkaW5nXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgYmxvY2tDb21tZW50T3BlblJhbmdlLmVuZCA9IGJsb2NrQ29tbWVudE9wZW5QYWRkZWRSYW5nZUVuZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgYnVmZmVyLmRlbGV0ZShibG9ja0NvbW1lbnRPcGVuUmFuZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIC8vIEVsc2UsIHdyYXAgc2VsZWN0aW9uIHdpdGggYmxvY2sgY29tbWVudC5cbiAgICAgIGJ1ZmZlci5pbnNlcnQocmFuZ2UuZW5kLCBwYWRkaW5nICsgY29tbWVudFRva2Vucy5jbG9zZSk7XG4gICAgICBidWZmZXIuaW5zZXJ0KHJhbmdlLnN0YXJ0LCBjb21tZW50VG9rZW5zLm9wZW4gKyBwYWRkaW5nKTtcblxuICAgICAgLy8gVW5zZWxlY3QgdGhlIG9wZW5pbmcgYW5kIGNsb3NpbmcgY29tbWVudCB0b2tlbnMuXG4gICAgICBjb25zdCBzdGFydFJvd0NvbHVtbk9mZnNldCA9IGNvbW1lbnRUb2tlbnMub3Blbi5sZW5ndGggKyBwYWRkaW5nLmxlbmd0aDtcbiAgICAgIHNlbGVjdGlvbi5zZXRCdWZmZXJSYW5nZShbXG4gICAgICAgIFtyYW5nZS5zdGFydC5yb3csIHJhbmdlLnN0YXJ0LmNvbHVtbiArIHN0YXJ0Um93Q29sdW1uT2Zmc2V0XSxcbiAgICAgICAgW3JhbmdlLmVuZC5yb3csIHJhbmdlLmVuZC5jb2x1bW4gKyAocmFuZ2Uuc3RhcnQucm93ID09PSByYW5nZS5lbmQucm93ID8gc3RhcnRSb3dDb2x1bW5PZmZzZXQgOiAwKV1cbiAgICAgIF0pO1xuICAgIH1cbiAgfSk7XG5cblxuICBmdW5jdGlvbiBpc0luc2lkZUJsb2NrQ29tbWVudChwb3NpdGlvbikge1xuICAgIGNvbnN0IHNjb3BlcyA9IGdldFBvc2l0aW9uU2NvcGVzKHBvc2l0aW9uKTtcbiAgICBjb25zdCBjb21tZW50U2NvcGVQcmVmaXggPSBgJHtpc1B5dGhvblNvdXJjZShzY29wZXMpID8gJ3N0cmluZy5xdW90ZWQuc2luZ2xlJyA6ICdjb21tZW50J30uYmxvY2suYDtcbiAgICByZXR1cm4gc2NvcGVzLnNvbWUoKHNjb3BlKSA9PiBzY29wZS5zdGFydHNXaXRoKGNvbW1lbnRTY29wZVByZWZpeCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gaXNDb21tZW50RGVmaW5pdGlvblB1bmN0dWF0aW9uKHBvc2l0aW9uKSB7XG4gICAgY29uc3Qgc2NvcGVzID0gZ2V0UG9zaXRpb25TY29wZXMocG9zaXRpb24pO1xuICAgIGNvbnN0IGNvbW1lbnRQdW5jdHVhdGlvblNjb3BlUHJlZml4ID0gYHB1bmN0dWF0aW9uLmRlZmluaXRpb24uJHtpc1B5dGhvblNvdXJjZShzY29wZXMpID8gJ3N0cmluZycgOiAnY29tbWVudCd9LmA7XG4gICAgcmV0dXJuIHNjb3Blcy5zb21lKChzY29wZSkgPT4gc2NvcGUuc3RhcnRzV2l0aChjb21tZW50UHVuY3R1YXRpb25TY29wZVByZWZpeCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0UG9zaXRpb25TY29wZXMocG9zaXRpb24pIHtcbiAgICByZXR1cm4gZWRpdG9yLnNjb3BlRGVzY3JpcHRvckZvckJ1ZmZlclBvc2l0aW9uKHBvc2l0aW9uKS5nZXRTY29wZXNBcnJheSgpO1xuICB9XG5cbiAgZnVuY3Rpb24gaXNBdENsb3NlQ29tbWVudFRva2VuKHBvc2l0aW9uLCBjbG9zZUNvbW1lbnRUb2tlbikge1xuICAgIHJldHVybiBwb3NpdGlvbi5jb2x1bW4gPj0gY2xvc2VDb21tZW50VG9rZW4ubGVuZ3RoXG4gICAgICAmJiBidWZmZXIuZ2V0VGV4dEluUmFuZ2UoW1twb3NpdGlvbi5yb3csIHBvc2l0aW9uLmNvbHVtbiAtIGNsb3NlQ29tbWVudFRva2VuLmxlbmd0aF0sIHBvc2l0aW9uXSkgPT09IGNsb3NlQ29tbWVudFRva2VuXG4gICAgICAmJiBpc0NvbW1lbnREZWZpbml0aW9uUHVuY3R1YXRpb24oW3Bvc2l0aW9uLnJvdywgcG9zaXRpb24uY29sdW1uIC0gMV0pO1xuICB9XG5cbiAgZnVuY3Rpb24gaXNQeXRob25Tb3VyY2Uoc2NvcGVzKSB7XG4gICAgcmV0dXJuIHNjb3Blc1swXSA9PT0gJ3NvdXJjZS5weXRob24nO1xuICB9XG5cbiAgZnVuY3Rpb24gaXNQeXRob25QdW5jdHVhdGlvbkRlZmluaXRpb25TdHJpbmdCZWdpbihzY29wZSkge1xuICAgIHJldHVybiBzY29wZSA9PT0gJ3B1bmN0dWF0aW9uLmRlZmluaXRpb24uc3RyaW5nLmJlZ2luLnB5dGhvbic7XG4gIH1cblxuICBmdW5jdGlvbiBpc1B5dGhvblN0cmluZ0Jsb2NrQmVnaW4ocG9zaXRpb24pIHtcbiAgICByZXR1cm4gaXNJbnNpZGVCbG9ja0NvbW1lbnQocG9zaXRpb24pICYmIChcbiAgICAgIGdldFBvc2l0aW9uU2NvcGVzKHBvc2l0aW9uKS5zb21lKGlzUHl0aG9uUHVuY3R1YXRpb25EZWZpbml0aW9uU3RyaW5nQmVnaW4pIHx8XG4gICAgICAvLyBBdG9tIGRvZXMgbm90IGlkZW50aWZ5IHRoZSBwb3NpdGlvbiBhdCB0aGUgZW5kIG9mIHRoZSBiZWdpbiB0b2tlbiBhcyBwYXJ0IG9mIGl0cyBzY29wZSwgdGhlcmVmb3JlIHdlIGNoZWNrIG9uZSBjb2x1bW4gdG8gdGhlIGxlZnQgYXMgd2VsbC5cbiAgICAgIChwb3NpdGlvbi5jb2x1bW4gPiAwICYmIGdldFBvc2l0aW9uU2NvcGVzKFtwb3NpdGlvbi5yb3csIHBvc2l0aW9uLmNvbHVtbiAtIDFdKS5zb21lKGlzUHl0aG9uUHVuY3R1YXRpb25EZWZpbml0aW9uU3RyaW5nQmVnaW4pKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==